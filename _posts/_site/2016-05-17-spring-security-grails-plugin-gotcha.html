<h2 id="spring-security-grails-plugin">Spring Security Grails Plugin</h2>

<p>Alright, our hero is doing a Grails application and wants some security in a brand new Grails 3.1.6 
application.  Good thing there’s a plugin for that and I can move onto the next thing right away.  Oh
 you sweet summer child.</p>

<p>Add the dependency in <code class="highlighter-rouge">build.gradle</code>:</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="s1">'org.grails.plugins:spring-security-core:3.1.1'</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Then I run the associated script to create the domain objects that are going to manage the
security like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grails s2-quickstart com.yourapp User Role --groupClassName=RoleGroup
</code></pre>
</div>

<p>Blissfully ignorant and following along with the documentation I charged forward.  Next up 
you quick data for development to associate the user to the role in <code class="highlighter-rouge">BootStrap.groovy</code>:</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="n">User</span> <span class="n">dneidetcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span>
        <span class="nl">username:</span> <span class="s1">'dneidetcher'</span><span class="o">,</span>
        <span class="nl">firstName:</span> <span class="s1">'Demian'</span><span class="o">,</span>
        <span class="nl">lastName:</span> <span class="s1">'Neidetcher'</span><span class="o">,</span>
        <span class="nl">emailAddress:</span> <span class="s2">"demian0311@gmail.com"</span><span class="o">,</span>
        <span class="nl">password:</span> <span class="s2">"foo"</span><span class="o">).</span><span class="na">save</span><span class="o">(</span><span class="nl">flush:</span> <span class="kc">true</span><span class="o">)</span>

<span class="n">UserRole</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">dneidetcher</span><span class="o">,</span> <span class="n">adminRole</span><span class="o">)</span>

<span class="n">UserRole</span><span class="o">.</span><span class="na">withSession</span> <span class="o">{</span>
    <span class="n">it</span><span class="o">.</span><span class="na">flush</span><span class="o">()</span>
    <span class="n">it</span><span class="o">.</span><span class="na">clear</span><span class="o">()</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Then I apply my annotation on a controller so that I can allow access to it based on role:</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">foo</span>

<span class="kn">import</span> <span class="nn">grails.plugin.springsecurity.annotation.Secured</span>

<span class="nd">@Secured</span><span class="o">(</span><span class="s1">'ROLE_ADMIN'</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="n">scaffold</span> <span class="o">=</span> <span class="n">User</span>
<span class="o">}</span>
</code></pre>
</div>

<h2 id="identifying-the-problem">Identifying the Problem</h2>

<p>Then you navigate to <a href="http://localhost:8080/user">http://localhost:8080/user</a> and you 
get <em>Sorry, you’re not authorized to view this page</em> and nothing really more helpful than that.</p>

<p>Turns out that our sad story really began when we added this <code class="highlighter-rouge">--groupClassName=RoleGroup</code> to 
the <code class="highlighter-rouge">s2-quickstart</code> command we used to generate the code.  The net of it is that my <code class="highlighter-rouge">BootStrap.groovy</code> code
that associated <code class="highlighter-rouge">User</code> to <code class="highlighter-rouge">Role</code> was insufficient.  The group stuff wants you to associate a <code class="highlighter-rouge">Group</code> with
a <code class="highlighter-rouge">Role</code> and then a <code class="highlighter-rouge">User</code> with that <code class="highlighter-rouge">Group</code> to get anything done.  That’s all fine but it’s a layer of
indirection I don’t think I need.  It took me over 3 hours to figure this out.</p>

<h2 id="the-fix">The Fix</h2>

<p>Well in the first place I should have done this for my <code class="highlighter-rouge">s2-quickstart</code> command.  That would have avoided the headache.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>grails s2-quickstart com.yourapp User Role 
</code></pre>
</div>

<p>But in my case I wanted to attempt to back out of the mess so this is what I did.</p>

<p>In <code class="highlighter-rouge">User</code> you need to change this function to this implementation:</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="n">Set</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span> <span class="n">getAuthorities</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">UserRole</span><span class="o">.</span><span class="na">findAllByUser</span><span class="o">(</span><span class="k">this</span><span class="o">)*.</span><span class="na">role</span>
<span class="o">}</span>
</code></pre>
</div>

<p>In <code class="highlighter-rouge">application.groovy</code> you need to change this attribute to be false:</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="n">grails</span><span class="o">.</span><span class="na">plugin</span><span class="o">.</span><span class="na">springsecurity</span><span class="o">.</span><span class="na">useRoleGroups</span> <span class="o">=</span> <span class="kc">false</span>
</code></pre>
</div>

<p>And you need to remove all of the Spring Security Plugin generated domain objects that have the word <code class="highlighter-rouge">Group</code> 
in them.  After that things worked as expected, Spring Security worked with my annotations.  So yeah, maybe 
not so much a <em>gotcha</em> but me not knowing Spring Security well enough.  Regardless, onward and upward.</p>
