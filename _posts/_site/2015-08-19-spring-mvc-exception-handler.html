<p>This is probably so obvious that it doesn’t deserve a blog post by anyone
but I’ll admit that I struggled with this for a few hours.  I have an API 
that I am putting together for a <a href="http://martinfowler.com/articles/microservices.html">microservice</a>.</p>

<p>This is a little JSON API and SpringMVC makes it very easy.  But when there
are exceptions most of the guides I found send you towards a <a href="http://www.thymeleaf.org/">Thymeleaf</a> solution
that outputs HTML.  That’s not what I want, I want a good HTTP response code
and a JSON response that the client can parse to help them figure out what
went wrong.  There’s a great write-up on <a href="https://spring.io/blog/2013/11/01/exception-handling-in-spring-mvc">exception handling in Spring</a> but that, I believe, takes you in the Thymeleaf direction as well.</p>

<h2 id="my-custom-exception">My Custom Exception</h2>

<p>Maybe this has my code too tied to HTTP but I like the explicit nature.  Notice
the <code class="highlighter-rouge">ResponseStatus</code> annotation that provides what <code class="highlighter-rouge">HttpStatus</code> we want associated
with this exception.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>package foo.bar;

import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ResponseStatus;

@ResponseStatus(value = HttpStatus.BAD_REQUEST)
public class BadRequestException extends RuntimeException {

    public BadRequestException(String messageIn) {
        super(messageIn);
    }
}
</code></pre>
</div>

<h2 id="using-the-exception">Using the Exception</h2>
<p>Nothing shocking here.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>throw new BadRequestException("something descriptive goes here");
</code></pre>
</div>

<h2 id="exceptionhandler">ExceptionHandler</h2>

<p>Spring lets you just annotate a method on a controller that you have designated to 
handle exceptions.  So yeah, this is the part that wasn’t obvious to me.  Sending 
back a <code class="highlighter-rouge">Map</code> tells Spring to just turn it into good JSON.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="nd">@ExceptionHandler</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">exceptionHandler</span><span class="o">(</span>
            <span class="n">Exception</span> <span class="n">e</span><span class="o">,</span>
            <span class="n">HttpServletRequest</span> <span class="n">httpServletRequestIn</span><span class="o">,</span>
            <span class="n">HttpServletResponse</span> <span class="n">httpServletResponseIn</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="c1">// if not production then show stack trace?</span>

        <span class="n">StringBuffer</span> <span class="n">url</span> <span class="o">=</span> <span class="n">httpServletRequestIn</span><span class="o">.</span><span class="na">getRequestURL</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">queryString</span> <span class="o">=</span> <span class="n">httpServletRequestIn</span><span class="o">.</span><span class="na">getQueryString</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">queryString</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">url</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'?'</span><span class="o">);</span>
            <span class="n">url</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">queryString</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"requestUrl"</span><span class="o">,</span> <span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">ResponseStatus</span> <span class="n">responseStatus</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">ResponseStatus</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">HttpStatus</span> <span class="n">httpStatus</span> <span class="o">=</span> <span class="n">responseStatus</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"httpStatus"</span><span class="o">,</span>  <span class="n">httpStatus</span><span class="o">.</span><span class="na">getReasonPhrase</span><span class="o">());</span>

            <span class="n">httpServletResponseIn</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">httpStatus</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>This all produces JSON that looks like this along with an HTTP response code of 400.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
    <span class="s2">"requestUrl"</span><span class="err">:</span> <span class="s2">"http://localhost:8080/controller"</span><span class="p">,</span>
    <span class="s2">"httpStatus"</span><span class="err">:</span> <span class="s2">"Bad Request"</span><span class="p">,</span>
    <span class="s2">"message"</span><span class="err">:</span> <span class="s2">"something descriptive goes here"</span>
<span class="p">}</span>
</code></pre>
</div>

