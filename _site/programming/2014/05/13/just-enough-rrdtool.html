<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Just Enough Rrdtool</title>
        <meta name="viewport" content="width=device-width"/>
        <link href='http://fonts.googleapis.com/css?family=Roboto' 
            rel='stylesheet' type='text/css'>
            
        <link rel="stylesheet" href="/css/syntax.css"/>
        <link rel="stylesheet" href="/css/main.css" type="text/css" media="screen"/>
        <link rel="stylesheet" href="/css/print.css" type="text/css" media="print"/>
    </head>
    <body>
        <div class="site">
          <div class="header">
            <h1><a href="/">Demian Neidetcher</a> | Just Enough Rrdtool</h1>
          </div>
          <div class="post">
<h2>DevOps</h2>

<p>If you get into devops you will run into <a href="http://oss.oetiker.ch/rrdtool/">RRDB</a>.  RRDB stands
for Round Robin DataBase.  It&#39;s a file that you set up with a fixed size based on 
what you tell it you want to store and how you want to retain that information.  The
consistent file size is important because even if the system you&#39;re tracking runs out of
disk space, your RRDB won&#39;t ask for more room.  The tooling around it doesn&#39;t use temp 
files or anything so your monitoring will all continue to work.  </p>

<p>At work some of my more motivated co-workers have stood up an instance of <a href="http://graphite.wikidot.com/">Graphite</a>.  Graphite
leverages RRDB to accept monitoring information and turn it into data and graphs that you can
render based on what you want to see.  </p>

<p>Recently I&#39;ve been working on a talk that I&#39;ve been giving that touches on devops.  In the talk I 
have live demos for <a href="https://en.wikipedia.org/wiki/Circuit_breaker_design_pattern">Circuit Breakers</a> (using the <a href="https://github.com/Netflix/Hystrix">Hystrix</a> project from <a href="http://www.netflix.com/">Netflix</a>).  But
I didn&#39;t have a compelling demonstration on how to turn data, logs or metrics into graphs.  Graphite 
and other tooling seemed too heavy for a little demo during a talk.  That and I 
thought it&#39;d be too heavy-weight for someone to play with right away.  So I decided to use
simple <a href="http://oss.oetiker.ch/rrdtool/">RRDtool</a> to work with RRDB files in a shell script.</p>

<p>I&#39;ll refine my use of RRDB later to do something live on a local system.  But I wanted something
that was gathering real data from a running system to show off.  That way I didn&#39;t have to 
think about how to create synthetic data.</p>

<h2>My Little Example</h2>

<p>My site is running on a <a href="http://www.rackspace.com/">RackSpace</a> virtual machine.  My web server is <a href="http://wiki.nginx.org/Main">NGINX</a>.  I&#39;m going to show
how to get <em>very rough</em> information out of my NGINX logs and turn that into pictures.</p>

<p>You can go to the <a href="https://gist.github.com/demian0311/fc5b45cc901d36889b5e">full script in a gist</a> but we&#39;ll walk through each section of a shell script.  It seemed
to make sense to me to put all these things together in one
script.  </p>

<p>Here we just define variables.
<code>
name=neidetcher_access
rrdfile=&quot;/var/local/${name}.rrd&quot;
imageDir=&quot;/home/demian/code/demian0311.github.com/_site&quot;
</code></p>

<h3>Create an RRDB</h3>

<p>Before you get going you need to set up an RRDB.  The <code>--step 60</code> says 
we want to store things in 60 second increments.  We also tell it about
a data source that&#39;s a GAUGE.  If anything comes in after 120 seconds then
we want to discard it.  And good values will be between 0 and 1000000.  We
also say that we want to keep around an average of the last hour and an
average of the last 24 hours.  rrdtool will take care of averaging all the
updates it gets into nice averages that we can later graph.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">rrdtool create $rrdfile --step 60 \
   &quot;DS:${name}:GAUGE:120:0:1000000&quot; \
   &quot;RRA:AVERAGE:0:1:60&quot; \
   &quot;RRA:AVERAGE:0:60:24&quot;
</code></pre></div>
<p>So, to do this step in my script I would run this one time to set things up:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">root@raven:~/bin# ./neidetcher_access_log.sh create
</code></pre></div>
<h3>Logtail &amp; rrdtool update</h3>

<p>Here we use logtail.  I have to admit up until 6 months ago I didn&#39;t even 
know logtail was a thing but it&#39;s pretty cool.  It reads a log file and 
keeps track of how far it got last time.  Then the next time you run it,
it&#39;ll start from that position.  It has smarts like knowing what the 
inode is of the file.  So if the file has been replaced it&#39;ll start over
at the top.</p>

<p>Here we just get a line count wich roughly correlates to the number of 
requests that came into NGINx.  We get that for two log files, add them
together and shove that value into our RRDB using <a href="http://oss.oetiker.ch/rrdtool/">rrdtool</a>.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">http_value=`/usr/sbin/logtail -f /var/log/nginx/neidetcher.access.log \
   -o /var/log/nginx/.neidetcher.access.log.offset | wc -l`
https_value=`/usr/sbin/logtail -f /var/log/nginx/ssl_neidetcher.access.log \
   -o /var/log/nginx/.ssl_neidetcher.access.log.offset| wc -l`
value=$(($http_value + $https_value))

rrdtool update $rrdfile N:${value}
</code></pre></div>
<p>That capability runs once a minute from cron.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">* * * * * /root/bin/neidetcher_access_log.sh update
</code></pre></div>
<h3>rrdtool graph</h3>

<p>Now the fun part where we graph the data that we&#39;ve been tracking.  The
first time we get 1 hour worth, the second time we get 24 hours worth.
We move that file into where all my static HTML is for my site and that&#39;s it.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">rrdtool graph ./${name}_hour.png \
         --start end-1h \
         DEF:${name}=${rrdfile}:${name}:AVERAGE \
         AREA:${name}#aa5555:${name}
mv -f ./${name}_hour.png ${imageDir}/${name}_hour.png

rrdtool graph ./${name}_day.png \
         --start end-24h \
         DEF:${name}=${rrdfile}:${name}:AVERAGE \
         AREA:${name}#aa5555:${name}
mv -f ./${name}_day.png ${imageDir}/${name}_day.png
</code></pre></div>
<p>The graphing runs once a minute as well from cron.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">* * * * * /root/bin/neidetcher_access_log.sh graph
</code></pre></div>
<h2>What that gets you</h2>

<p>Okay, lots of stuff there but now we have pretty graphs showing how 
often my site is visited.  As you can see I don&#39;t need to investigate CDN
options just yet.  My <a href="http://neidetcher.com/metrics.html">metrics</a> page shows the
graphs in action.</p>

<ul>
<li><a href="https://gist.github.com/demian0311/fc5b45cc901d36889b5e">My script</a> gist</li>
<li><a href="http://oss.oetiker.ch/rrdtool/">RRDTool</a></li>
<li><a href="https://www.fourmilab.ch/webtools/logtail/">LogTail</a></li>
<li><a href="http://neidetcher.com/metrics.html">My Metrics Page</a></li>
</ul>

</div>

          <div class="footer">
          This work is licensed under a
          <a rel="license" 
            href="http://creativecommons.org/licenses/by/4.0/deed.en_US"
            >Creative Commons Attribution 4.0 International License</a>.
          </div>
          <div class="printonly">
            http://neidetcher.com/programming/2014/05/13/just-enough-rrdtool.html<br/>
            <img src="/assets/images/resume_qrcode.png"/>
          </div>
        </div>
    </body>
</html>
