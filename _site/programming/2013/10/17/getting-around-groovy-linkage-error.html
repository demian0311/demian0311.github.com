<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Getting Around Groovy Linkage Error</title>
        <meta name="viewport" content="width=device-width"/>
        <link href='http://fonts.googleapis.com/css?family=Roboto' 
            rel='stylesheet' type='text/css'>
            
        <link rel="stylesheet" href="/css/syntax.css"/>
        <link rel="stylesheet" href="/css/main.css" type="text/css" media="screen"/>
        <link rel="stylesheet" href="/css/print.css" type="text/css" media="print"/>
    </head>
    <body>
        <div class="site">
          <div class="header">
            <h1><a href="/">Demian Neidetcher</a> | Getting Around Groovy Linkage Error</h1>
          </div>
          <div class="post">
<h2>A Hystrix Grails Plugin</h2>

<p>I am trying my hand at <a href="https://github.com/demian0311/hystrix-circuit-breaker">creating a Grails plugin</a>
that will pull in the 
<a href="https://github.com/Netflix/Hystrix">Netflix Hystrix circuit breaker</a> 
capability in your <a href="http://grails.org/">Grails</a> application.
I have never written Grails plugins before.  Holy cow writing Grails 
plugins is surprisingly straightforward.  It&#39;s awesome. </p>

<p>Part of the reason I&#39;m doing this is because we finally stumbled onto
the fact that using Grails plugins to manage your common code in an
enterprise is a good idea.  So we&#39;re doing that at work.</p>

<p>I&#39;m doing this with Netflix Hystrix because we use circuit breakers
at work in our Scala services.  Also, I am working on a talk to give in 2014 about
how to harden your application with respect to outgoing calls and the
concerns you should have with that.  Yes, I think <a href="https://en.wikipedia.org/wiki/Circuit_breaker_design_pattern">circuit breakers</a>
are one of those concerns you should have.</p>

<p>Integrating the Hystrix into a Grails plugin has been fun and surprisingly easy.
The hooks that Grails gives you for hacking at the web.xml file are nice.  My 
problems began when I wanted to configure my newly created circuit breaker.</p>

<h2>The Problem</h2>

<p>Groovy has a <a href="https://jira.codehaus.org/browse/GROOVY-6286">known problem (Cannot call Java static method with same name as inner class (LinkageError))</a>.
It&#39;s amusing that the author of that issue was attempting to do the
same thing I am; configure the Netflix Hystrix API.  I&#39;m not sure how common 
it is to have a static method with the same name as an inner class.</p>

<p>The offending class is <a href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommandProperties.html">HystrixCommandProperties</a>.
If you search that page for <em>Setter</em> you&#39;ll see the inner class and 
the static factory method they want you to use to create a new one.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">  LinkageError occurred when processing request: [GET] /hystrix-circuit-breaker/test
  loader constraint violation: when resolving method &quot;com.netflix.hystrix.HystrixCommandProperties.Setter()Lcom/netflix/hystrix/HystrixCommandProperties$Setter;&quot; the class loader (instance of org/codehaus/groovy/runtime/callsite/CallSiteClassLoader) of the current class, com/netflix/hystrix/HystrixCommandProperties$Setter, and the class loader (instance of groovy/lang/GroovyClassLoader) for resolved class, com/netflix/hystrix/HystrixCommandProperties, have different Class objects for the type com/netflix/hystrix/HystrixCommandProperties$Setter used in the signature. Stacktrace follows:
  org.codehaus.groovy.grails.web.servlet.mvc.exceptions.ControllerExecutionException: Executing action [index] of controller [hystrix.circuit.breaker.TestController] in plugin [hystrix-circuit-breaker] caused exception: Runtime error executing action
     at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)
     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918)
     at java.lang.Thread.run(Thread.java:680)
  Caused by: org.codehaus.groovy.grails.web.servlet.mvc.exceptions.ControllerExecutionException: Runtime error executing action
    ... 3 more
  Caused by: java.lang.reflect.InvocationTargetException
    ... 3 more
  Caused by: java.lang.LinkageError: loader constraint violation: when resolving method &quot;com.netflix.hystrix.HystrixCommandProperties.Setter()Lcom/netflix/hystrix/HystrixCommandProperties$Setter;&quot; the class loader (instance of org/codehaus/groovy/runtime/callsite/CallSiteClassLoader) of the current class, com/netflix/hystrix/HystrixCommandProperties$Setter, and the class loader (instance of groovy/lang/GroovyClassLoader) for resolved class, com/netflix/hystrix/HystrixCommandProperties, have different Class objects for the type com/netflix/hystrix/HystrixCommandProperties$Setter used in the signature
    at hystrix.circuit.breaker.DodgyStringReverser.createSetter(TestController.groovy:31)
    at hystrix.circuit.breaker.DodgyStringReverser.&lt;init&gt;(TestController.groovy:36)
    at hystrix.circuit.breaker.TestController.index(TestController.groovy:18)
    ... 3 more
</code></pre></div>
<h2>The Solution</h2>

<p>Groovy is the king of wild-ass options to call stuff so I thought 
I would try a bunch of different possibilities to see if they get me
around this issue.  I won&#39;t show all the ways that didn&#39;t work. 
Here&#39;s the way that seems to work.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">  static HystrixCommandProperties.Setter createHystrixCommandPropertiesSetter(){
      HystrixCommandProperties.invokeMethod(&quot;Setter&quot;, null)
  }
</code></pre></div>
<p>And <a href="https://github.com/demian0311/hystrix-circuit-breaker/blob/master/grails-app/controllers/hystrix/circuit/breaker/TestController.groovy">here&#39;s a link to my silly example that proves the concept</a>.</p>

</div>

          <div class="footer">
          <div class="printonly">
            http://neidetcher.com/programming/2013/10/17/getting-around-groovy-linkage-error.html
          </div>
          This work is licensed under a 
          <a rel="license" 
            href="http://creativecommons.org/licenses/by/4.0/deed.en_US"
            >Creative Commons Attribution 4.0 International License</a>.
          </div>
          <div class="printonly">
            <img src="/assets/images/resume_qrcode.png"/>
          </div>
        </div>
    </body>
</html>
